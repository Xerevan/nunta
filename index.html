<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bianca & Cătălin – Photo Booth (Drive)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0f0f12; --card:#17171c; --muted:#a0a3ad; --acc:#ff3b7f; --acc2:#7c3aed; --rad:18px; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0e0e12,#14141a);}    
    a{color:inherit}
    .container{max-width:960px;margin:0 auto;padding:20px}
    .card{background:linear-gradient(145deg,#17171c,#121218);border:1px solid #23232b;border-radius:var(--rad);box-shadow:0 10px 30px rgba(0,0,0,.35);}
    .hero{padding:36px 20px;text-align:center;color:#fff}
    .title{font-size:clamp(28px,6vw,40px);font-weight:800;letter-spacing:.3px;margin:0 0 6px}
    .subtitle{font-size:clamp(16px,3.5vw,18px);color:var(--muted);margin:0}
    .bigbtn{display:inline-flex;align-items:center;gap:10px;padding:16px 22px;margin-top:22px;border-radius:999px;background:linear-gradient(135deg,var(--acc),var(--acc2));color:#fff;font-weight:700;border:none;cursor:pointer;box-shadow:0 12px 24px rgba(255,59,127,.25);} .bigbtn:active{transform:translateY(1px)}
    .nav{display:flex;gap:10px;justify-content:center;margin-top:14px}
    .nav a{display:inline-flex;padding:10px 14px;border-radius:999px;background:#1b1b22;color:#eaeaf2;border:1px solid #282832;text-decoration:none}
    .footer{color:#7e8294;text-align:center;font-size:12px;margin:24px 0}
    dialog{border:none;border-radius:24px;background:#0f0f14;color:#fff;max-width:820px;width:95vw;padding:0;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#13131a;border-bottom:1px solid #252534}
    .modal-title{font-weight:700}
    .close{all:unset;cursor:pointer;padding:6px 10px;border-radius:8px;background:#1c1c25}
    .modal-body{display:grid;grid-template-columns:1fr;gap:16px;padding:16px}
    @media(min-width:800px){.modal-body{grid-template-columns:2fr 1fr}}
    #video,#preview{width:100%;border-radius:16px;background:#0b0b10;border:1px solid #232333;aspect-ratio:3/4;object-fit:cover}
    .controls{display:flex;flex-direction:column;gap:10px}
    .btn{padding:12px 14px;border-radius:12px;border:1px solid #2a2a38;background:#1a1a24;color:#fff;font-weight:600;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--acc),var(--acc2));border:none}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:640px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(min-width:920px){.grid{grid-template-columns:repeat(4,1fr)}}
    .thumb{position:relative;border-radius:14px;overflow:hidden;border:1px solid #272737;background:#0b0b10}
    .thumb img{width:100%;height:220px;object-fit:cover;display:block}
    .thumb .actions{position:absolute;inset:auto 8px 8px 8px;display:flex;gap:8px}
    .chip{background:rgba(15,15,20,.75);backdrop-filter:blur(6px);border:1px solid #2a2a38;color:#e6e7ef;padding:8px 10px;border-radius:10px;font-size:12px}
  </style>
</head>
<body>
  <main id="app"></main>
  <template id="landing-tpl">
    <div class="container">
      <section class="card hero">
        <h1 class="title">Bianca & Cătălin</h1>
        <p class="subtitle">Bine ați venit la nunta noastră – distracție plăcută și sperăm să aveți amintiri frumoase! 📸✨</p>
        <button id="openCamera" class="bigbtn">📷 Fă o poză și încarc‑o</button>
        <div class="nav">
          <a href="#/galerie">Vezi toate pozele</a>
          <a href="#/test">Ping backend</a>
        </div>
      </section>
      <p class="footer">Host: GitHub Pages (static). Stocare: MEGA (MEGAdrop) sau Dropbox File Request – fără backend, fără CORS.</p>
    </div>
  </template>

  <template id="gallery-tpl">
    <div class="container">
      <section class="card hero" style="padding:18px 18px 6px">
        <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between">
          <div>
            <h2 class="title" style="font-size:clamp(22px,4.5vw,30px);margin:0">Galerie – Bianca & Cătălin</h2>
            <p class="subtitle" style="margin-top:4px">Toate fotografiile încărcate de invitați</p>
          </div>
          <div class="row">
            <button id="btnRefresh" class="btn">🔄 Reîncarcă</button>
            <button id="btnDownloadAll" class="btn primary">⬇️ Descarcă tot</button>
            <a class="btn" href="#/">⬅️ Înapoi</a>
          </div>
        </div>
        <div style="margin:14px 0 20px" class="row">
          <span class="chip" id="photoCount">—</span>
          <span class="chip">Public (link share)</span>
        </div>
      </section>
      <section class="container" style="padding:14px 0 28px">
        <div id="grid" class="grid"></div>
      </section>
    </div>
  </template>

  <dialog id="cameraModal">
    <div class="modal-header">
      <div class="modal-title">Fă o poză</div>
      <button class="close" id="closeModal">✕</button>
    </div>
    <div class="modal-body">
      <div>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none"></canvas>
      </div>
      <div class="controls">
        <img id="preview" alt="previzualizare" />
        <div class="row">
          <button class="btn" id="btnFlip">🔁 Schimbă camera</button>
          <label class="btn" for="fileInput">📁 Alege din galerie</label>
          <input id="fileInput" type="file" accept="image/*" capture="environment" hidden>
        </div>
        <button class="btn" id="btnCapture">📸 Fă fotografia</button>
        <button class="btn primary" id="btnUpload" disabled>⬆️ Încarcă fotografia</button>
      </div>
    </div>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script type="module">
    // === CONFIG (Link-only; no CORS) ===
    // Alege una din variante și lipește URL‑urile reale:
    // MEGA:  UPLOAD_URL = link MEGAdrop;  GALLERY_URL = link public folder
    // Dropbox: UPLOAD_URL = link File Request; GALLERY_URL = link folder share (view)
    window.APP = {
      UPLOAD_URL: "https://www.dropbox.com/request/qIhg3HMcFhIlmwZREn6Z",
      GALLERY_URL: "https://www.dropbox.com/scl/fo/wh397e8ebaf73wvw0rwmc/AKF5h__XMuJiC73ZBsCOt-8?rlkey=wic94iz7whpx8rjrp0y6n22ir&st=tabc5104&dl=0",
      EVENT_SLUG: "bianca-catalin-2025"
    };

    const $ = s=>document.querySelector(s);
    const appRoot = $('#app');
    const routes = { '#/': renderLanding, '#/galerie': renderGallery };
    addEventListener('hashchange', ()=>{ (routes[location.hash||'#/']||renderLanding)(); });

    function renderLanding(){
      appRoot.innerHTML = document.querySelector('#landing-tpl').innerHTML;
      const btn = document.getElementById('openCamera');
      btn.textContent = '📤 Deschide pagina de upload';
      btn.onclick = ()=>{ if(!APP.UPLOAD_URL.includes('http')) alert('Completează UPLOAD_URL în config!'); else window.open(APP.UPLOAD_URL,'_blank'); };
    }

    function renderGallery(){
      appRoot.innerHTML = document.querySelector('#gallery-tpl').innerHTML;
      const grid = document.getElementById('grid');
      const wrap = document.createElement('div');
      wrap.className = 'card hero';
      wrap.style.margin = '10px 0 20px';
      wrap.innerHTML = `
        <p class="subtitle">Galeria se deschide în platforma de stocare (MEGA/Dropbox). Acolo ai și opțiunea "Download as ZIP".</p>
        <div class="row" style="justify-content:center">
          <a class="btn primary" target="_blank" href="${APP.GALLERY_URL}">🔍 Deschide galeria</a>
          <a class="btn" target="_blank" href="${APP.GALLERY_URL}">⬇️ Descarcă tot (din UI)</a>
          <a class="btn" href="#/">⬅️ Înapoi</a>
        </div>`;
      grid.replaceWith(wrap);
      document.getElementById('photoCount').textContent = 'Galerie externă';
    }

    // first render
    (routes[location.hash||'#/']||renderLanding)();
  </script>

  <!-- ================= SUPABASE STORAGE – POLITICI RLS =================
  1) Storage → Create bucket `photos` și bifează `Public`.
  2) SQL → rulează:

  -- permite citire publică din bucketul `photos`
  create policy if not exists "public read photos" on storage.objects
    for select to public using (bucket_id = 'photos');

  -- permite încărcare publică doar în subfolderul evenimentului (înlocuiește slugul)
  create policy if not exists "public upload event folder" on storage.objects
    for insert to public with check (
      bucket_id = 'photos' and name like 'bianca-catalin-2025/%'
    );

  -- (opțional) permite ștergere numai pentru rolul service (nu pentru public)
  -- delete/update NU sunt permise public implicit; le lași dezactivate.

  3) Project Settings → API → ia `Project URL` și `anon public` key, pune-le în `APP`.
  4) Test: Ping backend → List, apoi Test upload.
  ======================================================================= -->

  <!-- ================= GOOGLE APPS SCRIPT (backend gratuit) =================
  1) Creează un folder în Google Drive și ia FOLDER_ID (din URL).
  2) script.google.com → New project → Code.gs, lipește codul de mai jos, înlocuiește FOLDER_ID.
  3) Deploy → New deployment → Type: Web app → Execute as: Me → Who has access: Anyone → Deploy → copie URL (API_BASE).

  // ===== Code.gs =====
  const FOLDER_ID = 'PASTE_YOUR_FOLDER_ID';

  function doPost(e){
    try{
      const body = JSON.parse(e.postData.contents || '{}');
      const bytes = Utilities.base64Decode(body.data);
      const blob = Utilities.newBlob(bytes, body.mime || 'image/jpeg', body.filename || ('photo_'+Date.now()+'.jpg'));
      const folder = DriveApp.getFolderById(FOLDER_ID);
      const file = folder.createFile(blob);
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      const out = { id:file.getId(), name:file.getName(), url:`https://drive.google.com/uc?id=${file.getId()}&export=download`, viewUrl:`https://drive.google.com/uc?id=${file.getId()}`, ts: new Date(file.getDateCreated()).getTime() };
      return ContentService.createTextOutput(JSON.stringify(out)).setMimeType(ContentService.MimeType.JSON);
    }catch(err){
      return ContentService.createTextOutput(JSON.stringify({error:String(err)})).setMimeType(ContentService.MimeType.JSON);
    }
  }

  function doGet(e){
    const action = (e.parameter.action||'list').toString();
    if(action==='list'){
      const folder = DriveApp.getFolderById(FOLDER_ID);
      const files = folder.getFiles();
      const out = [];
      while(files.hasNext()){
        const f = files.next();
        out.push({ id:f.getId(), name:f.getName(), url:`https://drive.google.com/uc?id=${f.getId()}&export=download`, viewUrl:`https://drive.google.com/uc?id=${f.getId()}`, ts: new Date(f.getDateCreated()).getTime() });
      }
      // răspuns JSON
      return ContentService.createTextOutput(JSON.stringify(out)).setMimeType(ContentService.MimeType.JSON);
    }
    // fallback text
    return ContentService.createTextOutput('OK');
  }

  // Notă CORS: Web App-urile Apps Script funcționează cu fetch cross-origin. Dacă întâmpini blocaj CORS, redeploy (New deployment) și asigură-te că accesul e "Anyone".

  ============================================================================ -->
</body>
</html>
